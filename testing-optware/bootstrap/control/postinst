#!/bin/sh

PID="org.webosinternals.optware"

# Handle execution as pmPostInstall.script
if [ -z "$IPKG_OFFLINE_ROOT" ]; then
  mount -o remount,rw /
fi

APPS=/media/cryptofs/apps

[ -d $APPS ] || { echo "Requires webOS 1.3.5 or later" ; exit 1 ; }

# Stop the service if running
/sbin/stop ${PID} || true

# Remove the upstart script
rm -f /etc/event.d/${PID} /var/palm/event.d/${PID}

# Remove the profile script
rm -f /etc/profile.d/optware /etc/profile.d/${PID}

# Migrate legacy /media/internal/.optware/optware.ext3 to /media/cryptofs
if [ -f /media/internal/.optware/optware.ext3 ] ; then
    /bin/mv /media/internal/.optware/optware.ext3 /media/cryptofs/
    /bin/rmdir /media/internal/.optware
fi

# Create the filesystem if it does not already exist
if [ ! -e /media/cryptofs/optware.ext3 ] ; then
    /bin/mkdir -p /media/cryptofs || \
	{ echo "ERROR: Cannot create /media/cryptofs directory" ; exit 1 ; }
    echo "Creating 64MB optware filesystem ..."
    /bin/dd if=/dev/zero of=/media/cryptofs/optware.ext3 bs=1024 count=65536 || \
	{ echo "ERROR: Cannot initialise /media/cryptofs/optware.ext3 file" ; exit 1 ; }
    /sbin/mkfs.ext3 -F -L optware /media/cryptofs/optware.ext3 || \
	{ echo "ERROR: Cannot make /media/cryptofs/optware.ext3 filesystem" ; exit 1 ; }
fi

# Remove any empty legacy installation directory
rmdir /var/opt || true

# Migrate legacy /var/opt installation directory to /opt
if [ -d /var/opt ] ; then
    /bin/umount /opt || true
    /bin/mount /media/cryptofs/optware.ext3 /opt || \
	{ echo "ERROR: Unable to mount /opt for migration" ; exit 1 ; }
    /bin/cp -a /var/opt/* /opt/ || \
	{ echo "ERROR: Error migrating /var/opt to /opt" ; umount /opt ; exit 1 ; }
    /bin/rm -rf /var/opt || \
	{ echo "ERROR: Error removing legacy /var/opt" ; umount /opt ; exit 1 ; }
    /bin/umount /opt ||  \
	{ echo "ERROR: Error unmounting /opt" ; exit 1 ; }
fi

# Install the profile script
mkdir -p /etc/profile.d/
cp $APPS/usr/palm/applications/${PID}/profile/${PID} /etc/profile.d/${PID}

# Install the upstart script
mkdir -p /var/palm/event.d
cp $APPS/usr/palm/applications/${PID}/upstart/${PID} /var/palm/event.d/${PID}

# Start ${PID}
/sbin/start -n ${PID}

exit 0
