description "Optware Bootstrap"

start on stopped finish

# Stop when the Software Update tool is about to install an update.
# upstart restarts the job when installation is complete.
stop on started start_update

console output

pre-start script

[ -e /media/internal/.optware/optware.ext3 ] || \
  { logger -t upstart -p daemon.err "(org.webosinternals.optware) missing /media/internal/.optware/optware.ext3 filesystem" ; return 1 ; }

[ -e /opt ] || mkdir -p /opt || \
  { logger -t upstart -p daemon.err "(org.webosinternals.optware) unable to create the /opt directory" ; return 1 ; }

if cut -d' ' -f2 < /proc/mounts | grep -q ^/opt$; then
  logger -t upstart -p daemon.warn "(org.webosinternals.optware) the /opt directory is already mounted"
else
  mount -o loop /media/internal/.optware/optware.ext3 /opt || \
    { logger -t upstart -p daemon.err "(org.webosinternals.optware) unable to mount the /opt directory" ; return 1 ; }
  logger -t upstart -p daemon.info "(org.webosinternals.optware) mounted /media/internal/.optware/optware.ext3 on /opt"
fi

end script

post-stop script

if cut -d' ' -f2 < /proc/mounts | grep -q ^/opt$; then
  umount /opt
  logger -t upstart -p daemon.info "(org.webosinternals.optware) unmounted the /opt directory"
else
  logger -t upstart -p daemon.warn "(org.webosinternals.optware) the /opt directory was not mounted"
fi

end script